// Copyright (c) 2025 John Mark White -- US Amateur Radio License: W4KUS
//
// Licensed under the MIT License - see LICENSE file for details.

#include <stdio.h>
#include <complex>
#include <vector>
#include <memory>
#
#include "firinterp.h"
#include "cmdline.h"

// 4K @ 48Ksps
const float test_sig[256] =
{
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, -0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000
};

const float lp_test_8p5K_48k[65] =
{
	-0.000645, 0.000135, 0.000898, 0.000754, -0.000445, -0.001570, -0.001046, 0.001195,
    0.002836, 0.001296, -0.002716, -0.004727, -0.001152, 0.005367, 0.007170, 0.000123,
    -0.009549, -0.009988, 0.002475, 0.015807, 0.012921, -0.007732, -0.025188, -0.015658,
    0.017936, 0.040562, 0.017889, -0.040379, -0.073915, -0.019348, 0.125724, 0.284391,
    0.353157, 0.284391, 0.125724, -0.019348, -0.073915, -0.040379, 0.017889, 0.040562,
    0.017936, -0.015658, -0.025188, -0.007732, 0.012921, 0.015807, 0.002475, -0.009988,
    -0.009549, 0.000123, 0.007170, 0.005367, -0.001152, -0.004727, -0.002716, 0.001296,
    0.002836, 0.001195, -0.001046, -0.001570, -0.000445, 0.000754, 0.000898, 0.000135,
    -0.000645
};

constexpr size_t sigNum = sizeof(test_sig) / sizeof(test_sig[0]);
constexpr size_t tapNum = sizeof(lp_test_8p5K_48k) / sizeof(lp_test_8p5K_48k[0]);
constexpr size_t chunkNum = sigNum / 64;
constexpr size_t chunkSize = 64;
constexpr size_t L = 3;

int main(int argc, char **argvp)
{
    FILE *f = fopen("firinterp-float.txt", "w");
    dsp::firinterp interp { L, tapNum, lp_test_8p5K_48k };

    auto out = new float[chunkSize * L];

    for (size_t i=0;i < chunkNum;i++)
    {
        interp.filter(chunkSize, &test_sig[i * chunkSize], out);
        util::printReal(f, chunkSize * L, out);
    }

    delete []out;
    fclose(f);

	f = fopen("firinterp-complex.txt", "w");

	auto ctest_sig = new std::complex<float>[sigNum * (sizeof(std::complex<float>) / sizeof(float))];
	auto *cplexout = new std::complex<float>[sigNum * (sizeof(std::complex<float>) / sizeof(float)) * L];

	for (size_t i=0;i < sigNum;i++)
	{
		ctest_sig[i].real(test_sig[i]);
		ctest_sig[i].imag(0.0f);
	}

    for (size_t i=0;i < chunkNum;i++)
    {
        interp.filter(chunkSize, &ctest_sig[i * chunkSize], cplexout);
        util::printComplex(f, chunkSize * L, cplexout);
    }

	delete []ctest_sig;
	delete []cplexout;
	fclose(f);

    return 0;
}
