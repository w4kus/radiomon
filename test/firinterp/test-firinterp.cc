// Copyright (c) 2025 John Mark White -- US Amateur Radio License: W4KUS
//
// Licensed under the MIT License - see LICENSE file for details.

#include <stdio.h>
#include <complex>
#include <vector>
#include <memory>

#include "firinterp.h"
#include "cmdline.h"
#include "aligned_ptr.h"

// 4K @ 48Ksps
const float test_sig[256] =
{
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, -0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, 0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, 0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000,
	-0.866025, -1.000000, -0.866025, -0.500000, -0.000000, 0.500000, 0.866025, 1.000000,
	0.866025, 0.500000, -0.000000, -0.500000, -0.866025, -1.000000, -0.866025, -0.500000,
	-0.000000, 0.500000, 0.866025, 1.000000, 0.866025, 0.500000, 0.000000, -0.500000
};

const float lp_test_8p5K_48k[65] =
{
	-0.000645, 0.000135, 0.000898, 0.000754, -0.000445, -0.001570, -0.001046, 0.001195,
    0.002836, 0.001296, -0.002716, -0.004727, -0.001152, 0.005367, 0.007170, 0.000123,
    -0.009549, -0.009988, 0.002475, 0.015807, 0.012921, -0.007732, -0.025188, -0.015658,
    0.017936, 0.040562, 0.017889, -0.040379, -0.073915, -0.019348, 0.125724, 0.284391,
    0.353157, 0.284391, 0.125724, -0.019348, -0.073915, -0.040379, 0.017889, 0.040562,
    0.017936, -0.015658, -0.025188, -0.007732, 0.012921, 0.015807, 0.002475, -0.009988,
    -0.009549, 0.000123, 0.007170, 0.005367, -0.001152, -0.004727, -0.002716, 0.001296,
    0.002836, 0.001195, -0.001046, -0.001570, -0.000445, 0.000754, 0.000898, 0.000135,
    -0.000645
};

constexpr size_t sigNum = sizeof(test_sig) / sizeof(test_sig[0]);
constexpr size_t tapNum = sizeof(lp_test_8p5K_48k) / sizeof(lp_test_8p5K_48k[0]);
constexpr size_t chunkNum = sigNum / 64;
constexpr size_t chunkSize = 64;
constexpr size_t L = 3;

int main(int argc, char **argvp)
{
    FILE *f = fopen("firinterp-float.txt", "w");
    dsp::firinterp interp { L, util::make_aligned_ptr<float>(tapNum, lp_test_8p5K_48k) };

	auto out = util::make_aligned_ptr<float>(chunkSize * L);
	auto sig = util::make_aligned_ptr<float>(chunkSize, test_sig);
	auto *p = (float *)sig.get();

    for (size_t i=1;i < chunkNum;i++)
    {
		interp.filter(sig, out);
		util::printReal(f, chunkSize * L, out.get());

		if ((i + 1) < chunkNum)
			memcpy(p, &test_sig[i * chunkSize], chunkSize * sizeof(float));
    }

    fclose(f);

	f = fopen("firinterp-complex.txt", "w");

	auto csig = util::make_aligned_ptr<std::complex<float>>(sigNum);
	auto cout = util::make_aligned_ptr<std::complex<float>>(chunkSize * L);
	auto *cp = (std::complex<float> *)csig.get();

	for (size_t i=0;i < sigNum;i++)
	{
		cp[i].real(test_sig[i]);
		cp[i].imag(0.0f);
	}

	auto cin = util::make_aligned_ptr<std::complex<float>>(chunkSize, csig.get());
	cp = (std::complex<float> *)cin.get();

    for (size_t i=1;i < chunkNum;i++)
    {
        interp.filter(cin, cout);
        util::printComplex(f, chunkSize * L, cout.get());

		if ((i + 1) < chunkNum)
			memcpy(cp, &csig.get()[i * chunkSize], chunkSize * sizeof(std::complex<float>));
    }

	fclose(f);

    return 0;
}
