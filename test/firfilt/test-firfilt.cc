// Copyright (c) 2025 John Mark White -- US Amateur Radio License: W4KUS
//
// Licensed under the MIT License - see LICENSE file for details.

#include <stdio.h>
#include <complex>
#include <vector>
#include <memory>
#include <algorithm>

#include "firfilt.h"
#include "cmdline.h"

// 4K + 12K @ 48Ksps
const float test_sig[512] =
{
	0.866025, -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000,
    0.000000, -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, -0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, 0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, 0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, -0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000, 0.000000,
    -0.500000, 0.866025, 2.000000, 0.866025, -0.500000, -0.000000, 0.500000, -0.866025,
    -2.000000, -0.866025, 0.500000, 0.000000, -0.500000, 0.866025, 2.000000, 0.866025,
    -0.500000, -0.000000, 0.500000, -0.866025, -2.000000, -0.866025, 0.500000
};

const float lp_hamming_6k_large[321] =
{
	-0.000078, -0.000160, -0.000149, -0.000051, 0.000080, 0.000167, 0.000159, 0.000057,
    -0.000084, -0.000181, -0.000175, -0.000065, 0.000091, 0.000201, 0.000198, 0.000076,
    -0.000100, -0.000228, -0.000228, -0.000090, 0.000112, 0.000262, 0.000265, 0.000108,
    -0.000127, -0.000304, -0.000311, -0.000130, 0.000144, 0.000353, 0.000365, 0.000157,
    -0.000164, -0.000411, -0.000429, -0.000188, 0.000186, 0.000477, 0.000503, 0.000226,
    -0.000210, -0.000553, -0.000588, -0.000270, 0.000236, 0.000637, 0.000684, 0.000320,
    -0.000263, -0.000731, -0.000792, -0.000379, 0.000293, 0.000836, 0.000913, 0.000446,
    -0.000324, -0.000951, -0.001049, -0.000522, 0.000356, 0.001078, 0.001200, 0.000608,
    -0.000389, -0.001217, -0.001367, -0.000705, 0.000423, 0.001369, 0.001552, 0.000815,
    -0.000457, -0.001535, -0.001757, -0.000939, 0.000492, 0.001716, 0.001984, 0.001079,
    -0.000528, -0.001913, -0.002235, -0.001236, 0.000563, 0.002130, 0.002512, 0.001412,
    -0.000598, -0.002367, -0.002821, -0.001612, 0.000632, 0.002627, 0.003164, 0.001837,
    -0.000666, -0.002915, -0.003548, -0.002093, 0.000700, 0.003235, 0.003980, 0.002385,
    -0.000732, -0.003592, -0.004469, -0.002720, 0.000762, 0.003995, 0.005027, 0.003108,
    -0.000792, -0.004455, -0.005672, -0.003561, 0.000819, 0.004986, 0.006426, 0.004099,
    -0.000845, -0.005610, -0.007323, -0.004745, 0.000869, 0.006358, 0.008411, 0.005540,
    -0.000891, -0.007277, -0.009764, -0.006541, 0.000911, 0.008443, 0.011505, 0.007848,
    -0.000928, -0.009982, -0.013842, -0.009631, 0.000943, 0.012132, 0.017171, 0.012224,
    -0.000955, -0.015381, -0.022340, -0.016373, 0.000965, 0.020928, 0.031553, 0.024148,
    -0.000971, -0.032711, -0.052899, -0.044243, 0.000976, 0.075687, 0.159165, 0.224464,
    0.249130, 0.224464, 0.159165, 0.075687, 0.000976, -0.044243, -0.052899, -0.032711,
    -0.000971, 0.024148, 0.031553, 0.020928, 0.000965, -0.016373, -0.022340, -0.015381,
    -0.000955, 0.012224, 0.017171, 0.012132, 0.000943, -0.009631, -0.013842, -0.009982,
    -0.000928, 0.007848, 0.011505, 0.008443, 0.000911, -0.006541, -0.009764, -0.007277,
    -0.000891, 0.005540, 0.008411, 0.006358, 0.000869, -0.004745, -0.007323, -0.005610,
    -0.000845, 0.004099, 0.006426, 0.004986, 0.000819, -0.003561, -0.005672, -0.004455,
    -0.000792, 0.003108, 0.005027, 0.003995, 0.000762, -0.002720, -0.004469, -0.003592,
    -0.000732, 0.002385, 0.003980, 0.003235, 0.000700, -0.002093, -0.003548, -0.002915,
    -0.000666, 0.001837, 0.003164, 0.002627, 0.000632, -0.001612, -0.002821, -0.002367,
    -0.000598, 0.001412, 0.002512, 0.002130, 0.000563, -0.001236, -0.002235, -0.001913,
    -0.000528, 0.001079, 0.001984, 0.001716, 0.000492, -0.000939, -0.001757, -0.001535,
    -0.000457, 0.000815, 0.001552, 0.001369, 0.000423, -0.000705, -0.001367, -0.001217,
    -0.000389, 0.000608, 0.001200, 0.001078, 0.000356, -0.000522, -0.001049, -0.000951,
    -0.000324, 0.000446, 0.000913, 0.000836, 0.000293, -0.000379, -0.000792, -0.000731,
    -0.000263, 0.000320, 0.000684, 0.000637, 0.000236, -0.000270, -0.000588, -0.000553,
    -0.000210, 0.000226, 0.000503, 0.000477, 0.000186, -0.000188, -0.000429, -0.000411,
    -0.000164, 0.000157, 0.000365, 0.000353, 0.000144, -0.000130, -0.000311, -0.000304,
    -0.000127, 0.000108, 0.000265, 0.000262, 0.000112, -0.000090, -0.000228, -0.000228,
    -0.000100, 0.000076, 0.000198, 0.000201, 0.000091, -0.000065, -0.000175, -0.000181,
    -0.000084, 0.000057, 0.000159, 0.000167, 0.000080, -0.000051, -0.000149, -0.000160,
    -0.000078
};

const float lp_hamming_6k_small[33] =
{
	-0.000078, -0.001397, -0.002620, -0.002623, 0.000210, 0.006029, 0.011610, 0.010973, -0.000529,
    -0.020731, -0.038075, -0.035347, 0.000847, 0.070015, 0.153954, 0.222946, 0.249630, 0.222946,
    0.153954, 0.070015, 0.000847, -0.035347, -0.038075, -0.020731, -0.000529, 0.010973, 0.011610,
    0.006029, 0.000210, -0.002623, -0.002620, -0.001397, -0.000078
};

constexpr size_t tapNumLarge = sizeof(lp_hamming_6k_large) / sizeof(lp_hamming_6k_large[0]);
constexpr size_t tapNumSmall = sizeof(lp_hamming_6k_small) / sizeof(lp_hamming_6k_small[0]);
constexpr size_t sigNum = sizeof(test_sig) / sizeof(test_sig[0]);

int main(int argc, char **argvp)
{
    dsp::firfilter_ff testFir { util::make_aligned_ptr<float>(tapNumLarge, lp_hamming_6k_large) };

    FILE *f = fopen("ffilt-float.txt", "w");

    auto out = util::make_aligned_ptr<float>(64);

    for (size_t i=0;i < 8;i++)
    {
        auto seg = util::make_aligned_ptr<float>(64, &test_sig[i * 64]);
        testFir.filter(seg, out);
        util::printReal(f, out.size(), out.get());
    }

    fclose(f);

    f = fopen("ffilt-complex.txt", "w");
    auto outc = util::make_aligned_ptr<rm_math::complex_f>(64);
    auto sigc = std::make_unique<rm_math::complex_f[]>(sigNum);

    dsp::firfilter_cc testFirc { util::make_aligned_ptr<float>(tapNumLarge, lp_hamming_6k_large) };

    for (size_t i=0;i < sigNum;i++)
        sigc[i] = rm_math::complex_f { test_sig[i], 0.0f };

    for (size_t i=0;i < 8;i++)
    {
        auto seg = util::make_aligned_ptr<rm_math::complex_f>(64, &sigc[i * 64]);
        testFirc.filter(seg, outc);
        util::printComplex(f, out.size(), outc.get());
    }

    fclose(f);

    return 0;
}
